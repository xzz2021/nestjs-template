/**
 * 约定  规范
 * 1. 所有column字段小写开头
 * 2. 映射到数据库的字段应该以 蛇形命名  使用@map()
 * 3. 使用显式多对多关系表，明确级联操作
 * 4. 为常用查询字段添加合适的索引
 * 5. 使用枚举类型替代魔法数字
 */

/*
generator client {
  provider               = "prisma-client-js"
  output                 = "../../prisma/client/postgresql"
  // previewFeatures        = ["driverAdapters"]
  // Optional
  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
  url      = env("PG_DATABASE_URL")
}

generator prismaClassGenerator {
  provider      = "prisma-class-generator"
  useValidation = true // 是否添加 class-validator 装饰器
  dryRun        = false // ❗❗ 加上这个才能真正生成文件
  output        = "../../prisma/dto"
}




*/
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// generator caslAdapter {
//   provider = "node node_modules/@casl/prisma/generator.js" // <--- important to add this
//   clientLib = "./client/postgresql" // optional and by default equals to @prisma/client
//   output  = "./pg.casl.adapter.ts"
// }

// 使用常量字符串替代枚举，避免后续修改的限制
// 这些值在应用层定义，数据库层只存储字符串


/**
 * 所有金额,需要在数据库层约束 做非负限制
 * ALTER TABLE "YourTable"
 * ADD CONSTRAINT paid_amount_non_negative CHECK ("paid_amount" >= 0);
 */

model User {
  id               Int                @id @default(autoincrement())
  username         String             @db.VarChar(50)
  password         String             @db.VarChar(255)
  avatar           String?            @db.VarChar(255)
  email            String?            @unique @db.VarChar(50)
  phone            String             @unique @db.Char(11)
  birthday         String?
  gender           String?            @default("OTHER")
  status           Boolean            @default(true)
  wechatId         String?            @unique
  isDeleted        Boolean            @default(false) @map("is_deleted")
  createdAt        DateTime           @default(now()) 
  updatedAt        DateTime           @updatedAt 
  failedLoginCount Int                @default(0) @map("failed_login_count")
  lastLoginAt      DateTime?          @map("last_login_at")
  lastLoginIp      String?            @map("last_login_ip")
  lockLevel        Int                @default(0) @map("lock_level")
  lockedUntil      DateTime?          @map("locked_until")
  createdNotices   Notice[]
  noticeRecipients NoticeRecipient[]
  wechatInfo       WechatInfo?        @relation(fields: [wechatId], references: [unionid])
  departments      UserDepartment[]
  operationLogs    UserOperationLog[]
  roles            UserRole[]      // 显式多对多关系

  @@index([phone])
  @@index([email])
}

model WechatInfo {
  id           Int      @id @default(autoincrement())
  accessToken  String   @map("access_token")
  refreshToken String   @map("refresh_token")
  openid       String
  unionid      String   @unique
  nickname     String
  headimgurl   String?
  createdAt    DateTime @default(now()) 
  updatedAt    DateTime @updatedAt 
  user         User?

  @@index([openid])
  @@index([unionid])
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique @db.VarChar(50)
  code        String           @unique @db.VarChar(50)
  status      Boolean          @default(true)
  remark      String?          @db.VarChar(100)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  menus       RoleMenu[]
  permissions RolePermission[]
  users       UserRole[]

  @@index([code, status])
}

model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int      
  roleId    Int      
  createdAt DateTime @default(now()) 
  updatedAt DateTime @updatedAt 
  // 当删除  某个 角色  或 用户时 需要 级联删除 用户角色关联表  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
   role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
   user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Permission {
  id        Int              @id @default(autoincrement())
  name      String           @db.VarChar(50)
  code      String           @db.VarChar(50)
  resource  String           @db.VarChar(50)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  menuId    Int              
  menu      Menu             @relation(fields: [menuId], references: [id], onDelete: Cascade)
  roles     RolePermission[]

  // @@unique([menuId, code])
  // 复合键  Prisma Client 查询中此字段的名称为 menuId_code
  @@unique([menuId, code])
}

/*

enum ResourceType {
  DOMAIN
  API
  UI
}

model Resource {
  id         Int           @id @default(autoincrement())
  code       String        @unique @db.VarChar(100) // 如 "order"、"user"、"report"
  name       String?       @db.VarChar(100)
  type       ResourceType  @default(DOMAIN)
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  permissions Permission[]
}

model Action {
  id         Int      @id @default(autoincrement())
  code       String   @unique @db.VarChar(50) // 如 "view" | "create" | ...
  name       String?  @db.VarChar(100)

  menuId Int  @map("menu_id")
  menu   Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@map("action")
}



*/

// 角色权限关联表 - 显式多对多关系
model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int        
  permissionId Int        
  createdAt    DateTime   @default(now()) 
  updatedAt    DateTime   @updatedAt 
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model Department {
  id        Int              @id @default(autoincrement())
  name      String           @db.VarChar(50)
  path      String           @db.VarChar(512)
  status    Boolean          @default(true)
  remark    String?          @db.VarChar(100)
  createdAt DateTime         @default(now()) 
  updatedAt DateTime         @updatedAt
  parentId  Int?             
  parent    Department?      @relation("DepartmentSelf", fields: [parentId], references: [id])
  children  Department[]     @relation("DepartmentSelf")
  users     UserDepartment[]
  // 使用复合唯一约束，包括一个虚拟字段
  @@unique([name, parentId], name: "unique_department_name_parent")
}

model UserDepartment {
  id           Int        @id @default(autoincrement())
  userId       Int        
  departmentId Int        
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, departmentId])
}

model Menu {
  id             Int          @id @default(autoincrement())
  name           String       @unique @db.VarChar(50)
  path           String       @db.VarChar(100)
  redirect       String?      @db.VarChar(100)
  type           Int?
  component      String       @db.VarChar(100)
  sort           Int          @default(0)
  status         Boolean      @default(true)
  createdAt      DateTime     @default(now()) 
  updatedAt      DateTime     @updatedAt 
  parentId       Int?         
  parent         Menu?        @relation("MenuSelf", fields: [parentId], references: [id])
  children       Menu[]       @relation("MenuSelf")
  meta           Meta?
  permissionList Permission[]
  roles          RoleMenu[]

  @@index([path])
}

model Meta {
  id         Int      @id @default(autoincrement())
  title      String?  @db.VarChar(50)
  icon       String?  @db.VarChar(50)
  affix      Boolean  @default(false)
  activeMenu Boolean  @default(false) @map("active_menu")
  alwaysShow Boolean  @default(false) @map("always_show")
  breadcrumb Boolean  @default(true)
  canTo      Boolean  @default(false) @map("can_to")
  hidden     Boolean  @default(false)
  noCache    Boolean  @default(false) @map("no_cache")
  noTagsView Boolean  @default(false) @map("no_tags_view")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  // 添加反向关系，当Menu被删除时，Meta也会被删除
  // 如果需要执行级联操作  必须在 被操作处 定义 关联字段  必须 @unique
  menuId     Int      @unique
  menu       Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)

}

model RoleMenu {
  id        Int      @id @default(autoincrement())
  roleId    Int      
  menuId    Int      
  createdAt DateTime @default(now()) 
  updatedAt DateTime @updatedAt 
  menu      Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, menuId])
  @@index([roleId])
  @@index([menuId])
}

model Notice {
  id          Int               @id @default(autoincrement())
  title       String            @db.VarChar(100)
  type        String            @default("ANNOUNCEMENT")
  content     String
  isPublished Boolean           @default(false) @map("is_published")
  isDeleted   Boolean           @default(false) @map("is_deleted")
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?         
  creatorId   Int               
  creator     User              @relation(fields: [creatorId], references: [id])
  recipients  NoticeRecipient[]

  @@index([creatorId])
  @@index([isDeleted])
  @@index([isPublished])
  @@index([createdAt])
}

model NoticeRecipient {
  id        Int      @id @default(autoincrement())
  noticeId  Int      
  userId    Int      
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now())
  notice    Notice   @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@unique([noticeId, userId])
  @@index([isRead])
}

model Dictionary {
  id          Int               @id @default(autoincrement())
  name        String            @db.VarChar(50)
  code        String            @unique @db.VarChar(50)
  sort        Int               @default(0)
  description String?           @db.VarChar(200)
  status      Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt 
  entries     DictionaryEntry[]

  @@index([code])
}

model DictionaryEntry {
  id           Int        @id @default(autoincrement())
  name         String     @db.VarChar(50)
  code         String     @db.VarChar(50)
  sort         Int        @default(0)
  status       Boolean    @default(true)
  description  String?    @db.VarChar(200)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  dictionaryId Int        
  dictionary   Dictionary @relation(fields: [dictionaryId], references: [id], onDelete: Cascade)

  @@unique([code, dictionaryId])
  @@index([code])
}

model UserOperationLog {
  id          Int      @id @default(autoincrement())
  userId      Int?     
  ip          String   @db.VarChar(50)
  userAgent   String   @map("user_agent") @db.VarChar(150)
  method      String   @db.VarChar(10)
  requestUrl  String   @map("request_url") @db.VarChar(150)
  status      String   @map("status") @db.VarChar(10)
  responseMsg String?  @map("response_msg") @db.VarChar(150)
  detailInfo  Json?    @map("detail_info")
  createdAt   DateTime @default(now())
  duration    Int
  user        User?    @relation(fields: [userId], references: [id])


}

model SystemLog {
  id        Int      @id @default(autoincrement())
  level     String   @db.VarChar(50)
  service   String   @db.VarChar(50)
  message   String   @db.VarChar(50)
  context   Json?
  createdAt DateTime @default(now()) 
  duration  Int


}

model File {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(255)
  mimeType  String   @db.VarChar(50)
  path      String   @db.VarChar(255)
  extension String?  @db.VarChar(20)
  size      Int
  url       String   @db.VarChar(255)
  createdAt DateTime @default(now()) 

  @@index([extension])
}



/*


User  - Profile  一对一
Post  - Comment 一对多
Post  - Category 多对多 

model User {
  id      Int      @id @default(autoincrement())
  posts   Post[]
  profile Profile?
}

model Profile {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [userId], references: [id])
  userId Int  @unique // relation scalar field (used in the `@relation` attribute above)
}

model Post {
  id         Int        @id @default(autoincrement())
  author     User       @relation(fields: [authorId], references: [id])
  authorId   Int // relation scalar field  (used in the `@relation` attribute above)
  categories Category[]
}

model Category {
  id    Int    @id @default(autoincrement())
  posts Post[]
}

//  对同一张表 定义多个  一对多关系  时  会产生歧义 需要设置@relation 的 name  字段

model User {
  id           Int     @id @default(autoincrement())
  name         String?
  writtenPosts Post[]  @relation("WrittenPosts")
  pinnedPost   Post?   @relation("PinnedPost")
}

model Post {
  id         Int     @id @default(autoincrement())
  title      String?
  author     User    @relation("WrittenPosts", fields: [authorId], references: [id])
  authorId   Int
  pinnedBy   User?   @relation("PinnedPost", fields: [pinnedById], references: [id])
  pinnedById Int?    @unique
}


//  显式多对多关系

model Post {
  id         Int                 @id @default(autoincrement())
  title      String
  categories CategoriesOnPosts[]
}

model Category {
  id    Int                 @id @default(autoincrement())
  name  String
  posts CategoriesOnPosts[]
}

model CategoriesOnPosts {
  post       Post     @relation(fields: [postId], references: [id])
  postId     Int // relation scalar field (used in the `@relation` attribute above)
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId Int // relation scalar field (used in the `@relation` attribute above)
  assignedAt DateTime @default(now())
  assignedBy String

  @@id([postId, categoryId])
}

*/